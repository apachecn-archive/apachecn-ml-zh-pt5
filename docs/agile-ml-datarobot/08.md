# *第六章*:用 DataRobot 建模

在这一章中，我们将看到 DataRobot 是如何被用来建立模型的。许多模型构建过程已经自动化，DataRobot 提供了许多自动探索各种算法的功能，并允许数据科学家微调他们想要构建的内容。这为数据科学团队节省了大量时间，并带来了比其他方式更多的模型探索。它还导致更好地坚持最佳实践，从而减少犯错误的机会。

在本章结束时，你将学会如何利用 DataRobot 建立各种模型。在本章中，我们将讨论以下主要话题:

*   配置建模项目
*   构建模型和模型排行榜
*   了解模型蓝图
*   构建集合模型

# 配置建模项目

在前一章中，我们创建了一个项目并执行了数据分析。我们还看到 DataRobot 自动为我们建立了几个模型。为了构建这些模型，我们使用了默认的项目设置。

在这一节中，我们将介绍 DataRobot 在默认情况下为我们做了什么，并看看我们如何微调该行为。如果您还记得，一旦我们点击项目页面上的**开始**按钮(参见 [*第五章*](B17159_05_Final_NM_ePub.xhtml#_idTextAnchor097)*使用 DataRobot* 进行探索性数据分析中的*图 5.1* ，我们就不能对项目选项进行任何更改。因此，我们将创建一个新项目来检查和选择我们想要的选项。

为此，让我们进入 DataRobot 并选择`Automobile Example 2`，如下图所示:

![Figure 6.1 – Uploading the dataset for a new project
](img/Figure_6.1_B17159.jpg)

图 6.1–为新项目上传数据集

您可以像之前一样选择相同的目标功能(价格)。现在，请点击屏幕底部的**显示高级选项**，而不是点击**开始**按钮。您现在将看到**高级选项**屏幕，如下图所示:

![Figure 6.2 – Advanced Options
](img/Figure_6.2_B17159.jpg)

图 6.2–高级选项

在这里，您可以看到分区选项。您可以看到默认设置，并可以根据需要更改它们。由于我们拥有的数据量非常有限，我已经将交叉验证的次数减少到`3`，并将坚持百分比减少到 15%。您可以轻松地更改这些值，并根据需要使用不同的设置运行。接下来，我们点击**智能下采样**选项卡，如下图所示:

![Figure 6.3 – Smart Downsampling
](img/Figure_6.3_B17159.jpg)

图 6.3–智能下采样

假设这不是一个分类问题，我们在这里不需要担心下采样。如果您有一个不平衡的数据集用于分类问题，您可以使用此选项进行缩减采样。现在让我们看看**特征约束**选项卡，如下图所示:

![Figure 6.4 – Feature Constraints
](img/Figure_6.4_B17159.jpg)

图 6.4–特征约束

在这里，您可以设置单调性等要素约束，即目标值是否随着要素值的增加而同向移动。在这一点上，我们认为没有必要设置这样的约束。在某些用例中，这种约束可能是法规要求的一部分。如果是，可以在这里指定。大多数用例不需要这样的约束。现在让我们点击**附加**选项卡，如下图所示:

![Figure 6.5 – Additional options
](img/Figure_6.5_B17159.jpg)

图 6.5–附加选项

在这里，我们看到一个选项来更改用于建模的**优化指标**。我发现 DataRobot 的建议非常好，你应该使用这个选项，除非你有令人信服的商业理由选择不同的指标。假设我们处于建模的早期阶段，并且我们有兴趣了解我们的数据，我们将选择**搜索交互**选项，取消选择**从顶级模型创建搅拌机**选项，并选择**仅包括具有 SHAP 值支持的模型**选项。正如在 [*第二章*](B17159_02_Final_NM_ePub.xhtml#_idTextAnchor039) 、*机器学习基础知识*、**沙普利附加解释** ( **SHAP** )值有助于理解模型，并将为我们的问题提供额外的见解。这可能会以模型准确性为代价，但是我们以后会担心提高准确性。如果您在此页面上继续向下滚动，您会看到更多选项，如下面的屏幕截图所示:

![Figure 6.6 – More options
](img/Figure_6.6_B17159.jpg)

图 6.6–更多选项

在这里，您可以设置选项来设置运行时间的上限，限制目标变量预测的值，设置随机种子，或者为特定特性添加权重。目前，我们认为没有必要改变这些默认设置。

这就完成了配置过程，现在我们已经准备好构建模型了。

# 构建模型和模型排行榜

一旦我们完成了对配置设置的任何更改，我们可以向上滚动并点击**开始**按钮。DataRobot 现在将开始自动构建模型，如下图所示:

![Figure 6.7 – Automated building of models
](img/Figure_6.7_B17159.jpg)

图 6.7–模型的自动构建

您可以看到 DataRobot 正在构建哪些模型，以及使用了多少训练数据。你会注意到 DataRobot 会先用较小的数据集建立快速模型，了解哪一个执行得更好，然后有选择地用更多的数据建立模型。在目前的情况下，您可能看不到这一点，因为开始时几乎没有数据。DataRobot 完成模型构建后，将显示模型排行榜，如下图所示:

![Figure 6.8 – Model leaderboard
](img/Figure_6.8_B17159.jpg)

图 6.8–型号排行榜

在前面的屏幕截图中，您将看到根据您为交叉验证选择的指标，哪些模型上升到顶部。您还可以从下拉列表中选择不同的指标，以查看不同指标的模型比较情况。你可以清楚地看到哪些型号上升到了顶端。在顶级车型中，梯度推进车型并不少见。您还会注意到，基于所选择的指标，模型排名会有一些变化。您将看到，一旦 DataRobot 选择了要部署的模型，它就会解除对维持结果的锁定，并用 100%的数据对模型进行训练，为部署做好准备。现在，我们将忽略这一点，因为我们还没有准备好讨论部署。另一件需要注意的事情是用于顶级型号的特性列表。您会看到使用了新的**信息功能+** 功能列表。这是 DataRobot 为这些模型创建特性列表。让我们来看看这个列表包含了什么，如下:

![Figure 6.9 – New feature list
](img/Figure_6.9_B17159.jpg)

图 6.9–新功能列表

如你所见，这个列表包含了特性的子集，还包含了 DataRobot 自动创建的一个新特性:`(bore) DIVIDED BY (length)`。这个比率可能对一个引擎有的意义，你应该和**的主题专家** ( **中小企业**)讨论它的作用。如果以前不知道，这可能代表你的业务团队的新见解。原来这叫**冲程比**，被认为是发动机的重要参数。建模过程的下一步是看看是否需要进一步细化这个特性列表。让我们回到模型排行榜，选择表现最佳的模型**极端梯度提升树回归器(Gamma Loss)** ，转到**了解**选项卡，并选择**功能影响**子选项卡，如下图所示:

![Figure 6.10 – Understand and Feature Impact tabs
](img/Figure_6.10_B17159.jpg)

图 6.10–了解并展示影响选项卡

您将看到并不是每个模型都计算特性影响，所以继续点击 **Enable Feature Impact** 按钮让 DataRobot 计算它。单击后，DataRobot 将开始计算影响并向您显示结果，如下图所示:

![Figure 6.11 – Feature impacts
](img/Figure_6.11_B17159.jpg)

图 6.11–功能影响

您会注意到特性影响是使用我们之前讨论过的 SHAP 值计算的。默认情况下，它显示前 25 个功能。稍后我们将讨论特性和模型的细节。现在，我们想看看整个特性集。为此，我们将点击右下角的**导出**按钮。我们现在将看到**导出**选项，如下图所示:

![Figure 6.12 – Exporting feature impacts
](img/Figure_6.12_B17159.jpg)

图 6.12–导出功能影响

您可以下载这个信息作为一个`.csv`文件来更详细地研究它。让我们使用 Excel 打开`.csv`文件来查看特性影响，如下图所示:

![Figure 6.13 – Feature impacts of the entire set
](img/Figure_6.13_B17159.jpg)

图 6.13-整个集合的特征影响

正如你所看到的，最后七个特性并没有增加多少，我们可以试着删除它们，看看会有什么影响。像 DataRobot 这样的工具的一个好处是运行这些实验非常快速和容易。现在我们知道我们想要做什么，让我们回到**特征影响**屏幕。注意左下角的 **+创建特性列表**按钮。单击该按钮会弹出一个对话框，用于创建新的功能列表，如下面的屏幕截图所示:

![Figure 6.14 – Creating a new feature list
](img/Figure_6.14_B17159.jpg)

图 6.14–创建新的功能列表

在这里，我们可以给特性列表起一个新名字`FL1 top23`，并指定我们想要的 23 个最佳特性。现在，我们可以点击**创建特性列表**按钮来保存这个新的特性列表。现在一个新的特性列表已经创建，我们现在可以点击页面右侧栏中的**配置建模设置**。这将打开配置对话框，如下图所示:

![Figure 6.15 – Configure Modeling Settings
](img/Figure_6.15_B17159.jpg)

图 6.15–配置建模设置

我们现在可以从下拉菜单中选择新功能列表`FL1 top23`。如果需要，我们可以修改其他设置，点击**运行**按钮。DataRobot 现在将开始使用新功能列表构建模型，当该过程完成时，您可以在排行榜中看到新模型，如下图所示:

![Figure 6.16 – Leaderboard with new models
](img/Figure_6.16_B17159.jpg)

图 6.16–新型号排行榜

正如您所看到的，使用新功能列表构建的模型表现更好，现在位于排行榜的顶部(忽略部署就绪模型，因为它使用整个数据集)。正如我们所看到的，删除那些贡献不大的特性实际上对模型有所帮助(即使只是一点点)。考虑到该模型使用的功能较少，因此它是更理想的模型。我们可以根据需要继续这一进程。在这一点上，我们也开始更深入地研究模型的细节和它所产生的结果。我们将在下一章回到那个话题。现在，我们想看看模型蓝图或 DataRobot 建立模型的步骤。

# 了解模型蓝图

DataRobot 在构建模型时执行大量的数据转换和超参数调整。它利用了大量的最佳实践来构建一个特定类型的模型，并且这些最佳实践以蓝图的形式被编码。您可以检查这些蓝图，以深入了解这些最佳实践，并更好地理解构建模型所采取的步骤。要查看模型的蓝图，您可以点击模型，进入**描述**选项卡，然后选择**蓝图**选项卡，如下图所示:

![Figure 6.17 – Model blueprint
](img/Figure_6.17_B17159.jpg)

图 6.17–模型蓝图

在这里，您可以看到工作流程步骤。如您所见，这个蓝图相当简单。这是因为梯度增强方法非常灵活，不需要大量的预处理。让我们看看另一个做得很好的模型，**广义附加 2 模型(伽马损耗)**蓝图，如下面的截图所示:

![Figure 6.18 – Model blueprint for Generalized Additive2 Model (Gamma Loss)
](img/Figure_6.18_B17159.jpg)

图 6.18–广义附加 2 模型的模型蓝图(伽马损耗)

这里，您可以看到分类变量和缺失值都需要预处理。现在让我们看看另一个**深度学习**(**D1**)模型的蓝图。使用训练计划模型选择 **Keras Slim 残差神经网络回归器，并选择**蓝图**选项卡，如下图所示:**

![Figure 6.19 – Model blueprint for Keras
](img/Figure_6.19_B17159.jpg)

图 6.19-Keras 的模型蓝图

您可以看到，对于 Keras，我们需要对分类变量执行数据清理、缩放和一次性编码。您可以通过单击模型框来检查每个步骤的详细信息，如下图所示:

![Figure 6.20 – Process step details
](img/Figure_6.20_B17159.jpg)

图 6.20–流程步骤详情

现在，您可以看到关于执行了哪些任务以及使用了哪些超参数设置来构建模型的说明。此外，还有一个关于所用方法的其他详细信息的链接。检查完蓝图后，您可能会发现您最喜欢的算法之一没有被 DataRobot 使用，您可能会想知道该算法或模型的性能会是什么样子。为此，您可以单击页面左上角的**存储库**选项卡，如下图所示:

![Figure 6.21 – Repository of blueprints
](img/Figure_6.21_B17159.jpg)

图 6.21–蓝图的存储库

在这里，您将看到 DataRobot 提供的与该项目相关的所有蓝图。如你所见，这是一个相当全面的列表。请注意，对于不同类型的项目(例如，时序项目)，此列表会有所不同。你可以选择这些蓝图中的任何一个来建造一个模型。新型号将显示在排行榜上，您可以在那里评估其相对性能。目前，我们对这个特定的项目不感兴趣。

在这一点上，我们感兴趣的是比较一些模型，看看它们在更详细的层面上有多好。为此，让我们点击顶部最右边的标签，名为**车型对比**。这将打开一个页面，您可以在其中选择任意两个模型来查看它们是如何匹配的，如下面的屏幕截图所示:

![Figure 6.22 – Model Comparison
](img/Figure_6.22_B17159.jpg)

图 6.22–模型比较

在这里，我们选择了 XGBoost 模型和**广义加法模型** ( **GAM** )模型，用于跨多个指标进行比较。我们可以看到，这两个模型相距不远，您可以根据其他因素选择其中一个。正如我们之前所讨论的，gam 的优点是易于向业务用户解释，并且可以作为一个因素查找表来呈现，有时也称为评级表。选择 GAM 模型也可能有监管方面的原因。让我们点击**计算双升程数据**按钮，进入以下屏幕，进一步探索:

![Figure 6.23 – Dual lift chart
](img/Figure_6.23_B17159.jpg)

图 6.23–双举升图表

**双升力图**用于比较两个模型的结果。对于双提升图表，结果按照两个模型之间的差异(相对于目标值)排序。然后将这些值分箱，以显示每个箱的结果。阴影区域描述了两个模型之间的差异。在这里，我们再次看到这两个模型在性能上非常相似。

如果两个模型总体得分较高，但在此图表中显示出较大的数值偏差，则这些模型将是创建集成模型的良好候选。

# 建筑整体模型

众所周知，模型集合往往表现更好，也往往更稳健。DataRobot 提供自动建立集合模型的能力；然而，这确实需要一些权衡。例如，集合模型需要更多的时间和计算资源来构建和部署，并且它们也更不透明。这就是我们没有从建立集合模型开始的原因。一旦您构建了几个模型，并且对提高模型准确性的方法感兴趣，您就可以决定构建集成。正如我们在前面几节中看到的，我们必须显式地选择构建系综的选项，这也意味着我们不能计算 SHAP 值。让我们看看这是如何做到的。让我们首先转到项目列表页面，该页面显示了您当前的所有项目，如下图所示:

![Figure 6.24 – Project list
](img/Figure_6.24_B17159.jpg)

图 6.24–项目列表

在这里，我们将选择`Automobile Example 2`。从菜单中，我们将选择**复制**选项。你现在会看到**复制**对话框，如下图所示:

![Figure 6.25 – Duplicating a project
](img/Figure_6.25_B17159.jpg)

图 6.25–复制项目

我们可以给它起一个新名字`Automobile Example 3`，我们将选择**仅复制数据集**。这样，我们可以应用新的项目设置。让我们点击**确认**。这将创建一个新项目。我们可以选择目标价格，现在我们单击**高级选项**选项卡，如下图所示:

![Figure 6.26 – Advanced options for ensembles (blenders)
](img/Figure_6.26_B17159.jpg)

图 6.26–组合(搅拌机)的高级选项

这一次，我们将选择**从顶级车型创建搅拌机**选项，并取消选择**仅包括支持 SHAP 价值的车型**选项。现在，我们可以点击**开始**按钮，让 DataRobot 建立模型。DataRobot 完成模型构建后，我们可以检查排行榜，如下图所示:

![Figure 6.27 – Leaderboard with ensemble models
](img/Figure_6.27_B17159.jpg)

图 6.27–带有集合模型的排行榜

你会注意到数据机器人已经建造了一个 **AVG 搅拌机**模型，它似乎是最好的模型，但差不了多少。混合模型有时可以产生比单个模型大得多的升力，所以探索这个选项是值得的。我们可以选择该型号，点击**描述**选项卡，然后点击**蓝图**选项卡，如下图所示:

![Figure 6.28 – Blueprint for AVG Blender
](img/Figure_6.28_B17159.jpg)

图 6.28-AVG 搅拌机的蓝图

我们现在可以看到，blender 选择了两个 XGBoost 模型，因此 lift 也好不到哪里去也就不足为奇了。在这种情况下，我们不会选择混合模型，而是返回到上一个项目。

# 总结

在本章中，我们学习了如何利用 DataRobot 的功能来构建和比较模型。正如你所看到的，DataRobot 使快速构建许多模型变得非常容易，并帮助我们比较这些模型。正如你所经历的，我们尝试了很多东西，建立了几十个模型。这种快速的模型探索是 DataRobot 的关键能力，它对数据科学团队的重要性怎么强调都不为过。如果您自己用 Python 构建这些模型，将会花费更多的时间和精力。相反，我们用这些时间和思考来试验不同的想法，并把更多的精力放在理解问题上。我们还学习了编码最佳实践的蓝图。这些蓝图对于新的和有经验的数据科学家来说都是有用的学习工具。我们还学习了 DataRobot 如何为我们构建集合或混合模型。

向前一步并开始部署这些模型中的一个可能很有诱惑力，但重要的是不要在没有做一些分析的情况下就直接投入其中。我们现在准备更深入地挖掘模型，理解它们，看看我们是否能从中获得更多的见解。