

# 二、模型可解释方法

这本书的主要目标之一是让读者能够设计可解释的 ML 系统，这些系统可以在生产中用来解决关键的商业问题。对于一个健壮的可解释的 ML 系统，根据问题的类型和使用的数据类型，可解释性可以以多种方式提供。与图像和文本等非结构化数据相比，为结构化表格数据提供可解释性是相对友好的，因为图像或文本数据更复杂，可解释的粒度特征更少。

有不同的方法来增加 ML 模型的可解释性，例如，通过提取关于数据或模型的信息(知识提取)，使用有效的可视化来证明预测结果(结果可视化)，识别训练数据中的主导特征并分析其对模型预测的影响(基于影响的方法)，或者通过将模型结果与已知场景或情况进行比较作为示例(基于示例的方法)。

因此，在这一章中，我们将讨论各种模型不可知和模型特定的解释方法，这些方法用于结构化和非结构化数据的模型解释。

本章涵盖以下主要主题:

*   模型可解释性方法的类型
*   知识抽取方法
*   结果可视化方法
*   基于影响的方法
*   基于实例的方法

# 技术要求

本章的主要目标是提供对模型可解释性方法的概念性理解。但是，我将提供一些教程示例，在一些有趣的数据集上用 Python 实现其中的一些方法。在本书中，我们将使用 Python Jupyter 笔记本来运行代码并可视化输出。 [*第二章*](B18216_02_ePub.xhtml#_idTextAnchor033) 的代码和数据集资源可以从以下 GitHub 资源库下载或克隆:[https://GitHub . com/packt publishing/Applied-Machine-Learning-explability-Techniques/tree/main/Chapter 02](https://github.com/PacktPublishing/Applied-Machine-Learning-Explainability-Techniques/tree/main/Chapter02)。运行代码所需的其他重要 Python 框架将与其他相关细节一起在笔记本中提及，以理解这些概念中的代码实现。

# 模型解释方法的类型

有不同的方法可以用来提供模型的可解释性。某些技术是特定于模型的，某些方法被应用于模型的输入和输出。在本节中，我们将讨论用于解释 ML 模型的不同类型的方法:

*   **知识提取方法**:在**探索性数据分析** ( **EDA** )和事后分析期间，从数据中提取关键见解和统计信息是提供模型不可知解释能力的一种方式。通常，统计分析方法用于提取不同数据点的平均值和中值、标准偏差或方差，某些描述性统计用于估计预期的结果范围。

同样，使用相关热图、分解树和分布图的其他见解也用于观察特征之间的任何关系，以解释模型的结果。对于更复杂的非结构化数据，如图像，这些统计知识提取方法往往是不够的。使用**概念激活向量** ( **CAVs** )的人性化方法，如 [*第八章*](B18216_08_ePub.xhtml#_idTextAnchor154) 、*人性化解释与 TCAV* 所讨论的，更有效。

然而，主要地，知识提取方法提取关于输入数据和输出数据的基本信息，从中定义预期的模型结果。例如，为了解释一个时间序列预测模型，我们可以考虑一个模型性能度量，如训练期间预测误差的方差。误差率可以在(假设)+/- 10%的置信区间内指定。置信区间的形成只有在从输出训练数据中提取关键洞察之后才有可能。

*   **结果可视化方法**:绘制模型结果并将它们与之前的预测值进行比较，特别是使用代理模型，通常被认为是一种有效的模型不可知的可解释方法。来自黑盒 ML 算法的预测被传递给代理模型解释器。通常，这些是高度可解释的线性模型、决策树或任何基于规则的启发式算法，可以解释复杂模型的结果。这种方法的主要限制是可解释性仅仅依赖于模型结果。如果数据或建模过程有任何异常，那么这些可解释的维度就不会被捕获。

例如，让我们假设一个分类器错误地预测了一个输出。对于我们来说，仅仅从预测概率来理解为什么模型会以特定的方式运行是不可行的。但是这些方法很容易在实践中应用，甚至很容易理解，因为使用了高度可解释的解释器算法。

*   **基于影响的方法**:这些是帮助我们理解某些数据特征如何在影响或控制模型结果中发挥重要作用的特定技术。目前，这是为 ML 模型提供可解释性的最常用和最有效的方法之一。特征重要性、敏感性分析、关键影响者图、显著性图、**类激活图** ( **CAMs** )和其他视觉特征图用于解释数据中的单个特征如何被模型用于其决策过程。
*   **基于实例的方法**:之前讨论的三种模型不可知的可解释方法仍然需要某种技术知识来理解 ML 模型的工作。对于非技术用户来说，解释某事的最好方式是提供一个他们能理解的例子。基于实例的方法，尤其是反事实的基于实例的方法，试图查看数据的某些单一实例来解释 ML 模型的决策过程。

例如，假设一个由 ML 支持的自动化贷款审批系统拒绝了一个申请人的贷款请求。使用基于示例的可解释性方法，申请人还将被建议，如果他们在接下来的三个月中按时支付信用卡账单，并且每月收入增加 2000 美元，他们的贷款请求将被批准。

根据最新的趋势，模型不可知的技术比模型相关的方法更受欢迎，因为在某种程度上，甚至复杂的 ML 算法也可以用这些技术来解释。但是某些技术，比如显著图、基于树/森林的特征重要性和激活图，大多是特定于模型的。我们对解释方法的选择是由我们试图解决的关键问题决定的。

*图 2.1* 展示了四种主要类型的可解释性方法，这些方法已经被应用于解释黑盒模型的工作，我们将在下面的章节中介绍这些方法:

![Figure 2.1 – Model explainability methods
](img/B18216_02_01.jpg)

图 2.1–模型可解释性方法

现在，让我们从更详细地讨论这些模型可解释性方法开始。

# 知识提取方法

每当我们在任何背景下谈论可解释性时，它都是关于获得问题的知识，以便获得对预期结果的一些明确性。类似地，如果我们已经知道了结果，可解释性就是追溯到根本原因。ML 中的知识提取方法用于从输入数据中提取关键见解，或者利用模型结果追溯并映射到终端用户已知的结构化数据和非结构化数据的某些信息。虽然有多种方法来提取知识，但在实践中，EDA 的以数据为中心的过程是解释任何黑盒模型的最常见和最流行的方法之一。让我们在 **XAI** 的背景下讨论更多关于如何使用 EDA 过程的问题。

## EDA

我会一直认为 EDA 是任何 ML 工作流中最重要的过程。EDA 允许我们探索数据并得出关键的见解；利用这一点，我们可以从数据中形成某些假设。这实际上帮助我们识别数据中的任何独特模式，并最终帮助我们做出正确的算法选择。因此，EDA 是解释数据本质的传统和模型不可知的方法之一，通过考虑数据，它帮助我们理解从模型中期待什么。使用 EDA 可以很容易地发现任何明显的异常、模糊、冗余的数据点和数据偏差。现在，让我们看看 EDA 中使用的一些重要方法，来解释结构化和非结构化数据的 ML 模型。

### 结构化数据的 EDA

对结构化数据进行 EDA 是应用于提取洞察力以提供可解释性的初步步骤之一。然而，EDA 过程中应用的实际技术可能因问题而异。但一般来说，对于结构化数据，我们可以使用 EDA 来生成某些描述性统计数据，以便更好地理解数据，然后应用各种单变量和多变量方法来检测每个特征的重要性，观察数据的分布以找到数据中的任何偏差，并寻找异常值、重复值、缺失值、相关性以及特征之间的基数，这些都可能影响模型的结果。

从 EDA 步骤中获得的信息和假设有助于执行有意义的功能工程和建模技术，并有助于为涉众建立正确的期望。在本节中，我们将介绍最流行的 EDA 方法，并讨论在 XAI 环境中使用结构化数据的 EDA 的好处。我强烈建议查看 GitHub 存储库([https://GitHub . com/packt publishing/Applied-Machine-Learning-explability-Techniques](https://github.com/PacktPublishing/Applied-Machine-Learning-Explainability-Techniques))以在实践中应用其中的一些技术，作为实际用例。现在，让我们看看下面列表中的重要 EDA 方法:

*   **汇总统计**:通常，模型的可解释性是针对数据中的特征来呈现的。在 EDA 过程中观察数据集统计数据可以提供数据集是否足以建模和解决给定问题的早期指示。它有助于理解数据的维度和存在的特征类型。如果特征是数字的，则观察某些描述性统计，如平均值、标准偏差、变异系数、偏斜度、峰度和四分位间距。

此外，某些基于直方图的分布用于监控数据中的任何偏斜或偏差。对于分类特征，观察分类值的频率分布。如果数据集不平衡，如果数据集偏向某个特定类别值，如果数据集有异常值，或者偏向某个特定方向，所有这些都很容易观察到。由于所有这些因素都会影响模型预测，因此了解数据集统计数据对于模型的可解释性非常重要。

*图 2.2* 显示了在 EDA 步骤中为提取数据知识而创建的汇总统计和可视化:

![Figure 2.2 – Summary statistics and visualizations during EDA
](img/B18216_02_02.jpg)

图 2.2–EDA 过程中的汇总统计和可视化

*   **重复和缺失值**:重复或冗余值会给模型增加更多偏差。相比之下，缺少值会导致信息丢失，并且没有足够的数据来训练模型。这可能会导致模型过拟合。因此，在训练模型之前，如果观察到缺失值或重复值，并且如果不采取进一步的措施来纠正这种情况，那么这些观察结果可能有助于解释模型非泛化背后的原因。
*   **单变量分析**:这种包括通过图形技术分析单个特征，如分布图、直方图、箱线图、小提琴图、饼图、聚类图，以及使用非图形技术，如频率、集中趋势测量(即平均值、标准偏差和变异系数)和四分位间距。这些方法帮助我们估计单个特征对模型结果的影响。
*   **多变量分析**:这种包括使用图形和非图形方法一起分析两个或多个特征。它用于识别数据相关性和变量的依赖性。在 XAI 的背景下，与单变量分析方法相比，多变量分析用于理解数据中的复杂关系，并提供详细的粒度解释。
*   **异常值检测**:异常值是某些异常数据点，它们会完全扭曲模型。如果模型是在离群数据点上训练的，则很难实现泛化。然而，在异常数据点的模型推断时间内，模型预测可能会完全出错。因此，在训练和推理期间的异常检测是模型可解释性的一个重要部分。可视化方法，例如箱线图、散点图，以及统计方法，例如 1.5xIQR 规则([https://www . khanacademy . org/math/statistics-probability/summaring-quantitative-data/box-whisker-plots/a/identifying-outliers-iqr-Rule](https://www.khanacademy.org/math/statistics-probability/summarizing-quantitative-data/box-whisker-plots/a/identifying-outliers-iqr-rule))和 Nelson 规则([https://www . leansix sigma definition . com/glossary/Nelson-rules/](https://www.leansixsigmadefinition.com/glossary/nelson-rules/))用于检测异常。
*   **帕累托分析**:根据帕累托原理，80%的价值或影响是由 20%的样本量驱动的。因此，在 XAI，这个*80–20 规则*被用来解释对模型结果有最大影响的最有影响力的子样本。
*   **频繁** **项集挖掘**:这是另一种流行的提取模型可解释性的方法选择。这种技术经常用于关联规则挖掘，以了解在任何给定的数据集中某些观察值一起出现的频率。这种方法提供了一些有趣的观察结果，有助于从数据中形成重要的假设，并最终对解释模型结果做出很大贡献。

既然我们已经介绍了结构化数据的方法，那么让我们来看看非结构化数据的一些方法。

### 非结构化数据的 EDA

从图像和文本等非结构化数据中解释特征非常困难，因为 ML 算法试图识别人类无法直观解释的粒度级特征。然而，有某些特定的方法应用于图像和文本数据，以从数据中形成有意义的假设。如前所述，EDA 过程可能会根据问题和数据而变化，但在本章中，我们将讨论 XAI 环境中最流行的方法选择。

#### 探索图像数据

用于图像的 EDA 方法不同于用于表格数据的方法。以下是一些常见的图像数据集 EDA 步骤选择:

*   **数据维度分析**:对于一致和一般化的模型，理解数据维度很重要。监控图像的数量和每个图像的形状对于解释任何过拟合或欠拟合的观察是很重要的。
*   **观察数据分布**:由于使用图像解决的大部分问题都是分类问题，所以监控分类不平衡很重要。如果数据的分布不均衡，那么模型可能偏向多数类。对于像素级分类(对于分割问题)，观察像素强度分布很重要。这也有助于理解阴影或非均匀照明条件对图像的影响。
*   **观察平均图像和对比图像**:为了观察图像中占优势的感兴趣区域，通常使用平均图像和对比图像。这尤其用于基于分类的问题，以比较感兴趣的主要区域。
*   **高级统计和代数方法**:除了到目前为止讨论过的方法外，其他统计方法，如寻找 z 分数和标准偏差，以及代数方法，如基于特征向量的特征图像，都被用来直观地检查图像数据中的关键特征，这增加了最终模型结果的可解释性。

根据问题的类型，还有其他复杂的方法来探索影像数据集。然而，本小节中讨论的方法是最常见的方法。

#### 浏览文本数据

通常，与图像或表格数据集相比，文本数据更嘈杂。因此，EDA 通常伴随着一些对文本数据的预处理或清理方法。但是由于我们只关注 EDA 部分，下面的列表详细介绍了一些使用文本数据进行 EDA 的流行方法:

*   **数据维度分析**:类似于图像的，执行文本维度分析，例如检查记录的数量和每个记录的长度，以形成关于潜在过拟合或欠拟合的假设。
*   **观察数据分布**:可视化使用条形图或词云来观察词频分布是观察任何文本数据中的热门词的流行选择。这种技术使我们能够避免高频词与低频词相比的任何偏差。
*   **n 元语法分析**:考虑到文本数据的性质，通常，一个短语或一组单词比单个单词更容易理解。例如，对于来自电影评论的情感分析，诸如*电影*或*电影*之类的高频词是相当模糊的。相比之下，像*好电影*和*非常无聊的电影*这样的短语更容易理解，也更有助于理解情感。因此，n 元语法分析或取“n 个单词”的集合为理解模型结果带来了更多的可解释性。

通常，EDA 确实包括某些可视化技术来解释并从数据中形成一些重要的假设。但是解释 ML 模型的另一个重要技术是可视化模型结果。在下一节中，我们将更详细地讨论这些结果可视化方法。

# 结果可视化方法

模型结果的可视化是用于解释 ML 模型的一种非常常见的方法。通常，这些是模型不可知的、事后分析方法，应用于经过训练的黑盒模型，并提供可解释性。在下一节中，我们将讨论一些用于解释 ML 模型的常用结果可视化方法。

## 使用比较分析法

这些大多是事后分析方法，用于通过在训练过程后可视化模型的预测输出来增加模型的可解释性。大多数情况下，这些是模型不可知的方法，这些方法可以应用于本质上可解释的模型和黑盒模型。比较分析可以用来产生全局和局部的解释。它主要用于使用各种可视化方法比较结果的不同可能性。

例如，对于基于分类的问题，某些方法如 t-SNE 和 PCA 用于可视化和比较模型预测标签的变换特征空间，特别是在错误率高的时候。对于回归和时间序列预测模型，置信水平用于将模型预测结果与上限和下限进行比较。有多种方法可以应用比较分析，并更清楚地了解*假设*情景。在项目资源库中提到了一些突出的方法([https://github . com/packt publishing/Applied-Machine-Learning-explability-Techniques/blob/main/chapter 02/Comparison % 20 analysis . ipynb](https://github.com/PacktPublishing/Applied-Machine-Learning-Explainability-Techniques/blob/main/Chapter02/Comparison%20Analysis.ipynb))。

正如我们在*图 2.3* 中看到的，结果可视化有助于提供模型的全局视角，以可视化模型预测:

![Figure 2.3 – Comparison analysis using the t-SNE method for the classification problem (left-hand side) and the time series prediction model with the confidence interval (right-hand side)
](img/B18216_02_03.jpg)

图 2.3–使用 t-SNE 方法对分类问题(左侧)和带有置信区间的时间序列预测模型(右侧)进行比较分析

在*图 2.3* 中，我们可以看到可视化方法如何通过可视化模型的最终结果并与其他数据实例或可能的*假设情景*进行比较来提供局部解释，从而提供模型的全局视角。

## 使用代理解释器方法

在 ML 的上下文中，当外部模型或算法被应用于解释黑盒 ML 模型时，外部方法被称为**代理解释器方法**。这种方法背后的基本思想是应用一个本质上可解释的模型，该模型简单且易于解释，并尽可能精确地近似黑盒模型的预测。然后，使用某些可视化技术来可视化代理解释器方法的结果，以深入了解模型行为。

但是现在的问题是*我们能直接应用代理模型而不是使用黑箱模型吗？*答案是*不！*使用代理模型背后的主要思想是获得一些关于输入数据如何与目标结果相关的信息，而不考虑模型的准确性。相比之下，原始的黑盒模型更加准确和有效，但不可解释。因此，用代理模型完全取代黑盒模型会损害模型的准确性，这是我们不希望的。

回归、决策树和基于规则的算法等可解释算法是代理解释器方法的流行选择。为了提供可解释性，主要分析了输入特征和目标结果之间的三种类型的关系:线性、单调性和交互作用。

线性帮助我们检查输入特征是否与目标结果线性相关。单调性有助于我们分析整体输入特征值的增加会导致目标结果的增加还是减少。对于整个要素范围，这解释了输入要素和目标之间的关系是否总是沿同一方向传播。当提供可解释性时，模型交互非常有用，但是很难实现。交互有助于我们分析各个特性如何相互影响模型决策过程。

决策树和基于规则的算法用于检查输入特征和目标结果之间的相互作用。*克里斯托夫·莫尔纳*在他的书*可解释机器学习*([https://christophm.github.io/interpretable-ml-book/](https://christophm.github.io/interpretable-ml-book/))中，提供了一个非常有用的表格，比较不同的内在可解释模型，这对于选择可解释模型作为替代解释模型是有用的。

下表显示了这种情况的简化版本:

![Figure 2.4 – Comparing interpretable algorithms for selecting a Surrogate Explainer method
](img/B18216_02_04.jpg)

图 2.4–比较选择代理解释器方法的可解释算法

这种技术的一个主要优点是它可以帮助任何黑盒模型变得可解释。它与模型无关，并且非常容易实现。但是当数据复杂时，使用更复杂的算法来实现更高的建模精度。在这种情况下，替代方法往往会过度简化输入要素之间的复杂模式或关系。

*图 2.5* 说明了如何使用可解释的算法，如决策树、线性回归或任何基于启发式规则的算法作为替代模型来解释任何黑盒 ML 模型:

![Figure 2.5 – Using Surrogate explainers for model explainability
](img/B18216_02_05.jpg)

图 2.5–使用代理解释器来实现模型的可解释性

尽管这种方法有缺点，但线性、单调性和交互的可视化可以在很大程度上证明在复杂的黑盒模型上工作是合理的。在下一节中，我们将讨论基于影响的方法来解释 ML 模型。

# 基于影响的方法

基于影响的方法用于理解数据集中存在的特征对模型决策过程的影响。与其他方法相比，基于影响的方法被广泛使用和首选，因为这有助于从数据集中识别主导属性。从结构化和非结构化数据中识别主导属性有助于我们分析主导特征在影响模型结果中的作用。

例如，让我们说你正在研究一个对狼和西伯利亚哈士奇进行分类的分类问题。假设经过训练和评估过程，你已经取得了 95%以上准确率的好模型。但是，当试图使用基于影响的方法来寻找模型可解释性的重要特征时，您观察到模型将周围的背景作为主要特征来分类它是狼还是哈士奇。在这种情况下，即使你的模型结果看起来非常准确，你的模型也是不可靠的。这是因为模型做出决策所依据的特征并不健壮和通用。

基于影响的方法普遍用于执行根本原因分析，以调试 ML 模型和检测 ML 系统中的故障。现在，让我们讨论一些用于模型可解释性的基于影响的方法的流行选择。

## 特征重要性

在应用 ML 模型时，理解每个特征在影响模型结果方面的相对重要性是至关重要的。这是一种根据要素在预测目标值中的有用性为数据集中的输入要素分配特定分值的技术。特征重要性是对结构化数据建模的模型不可知可解释性的一个非常流行的选择。虽然有各种评分机制来确定特性的重要性，如排列重要性分数、统计相关性分数、基于决策树的评分等等，但在本节中，我们将主要关注整体方法，而不仅仅是评分机制。

在 XAI 的上下文中，特征重要性可以提供对数据和模型行为的全局洞察。它通常用于特征选择和降维，以提高 ML 模型的效率。通过从建模过程中移除不太重要的特征，已经观察到，通常，整体模型性能得到改善。

重要特征的概念有时取决于评分机制的类型或所用模型的类型。因此，建议您在得出任何结论之前，与领域专家一起验证这项技术获得的重要特性。这种方法适用于结构化数据集，其中的特征已明确定义。对于文本或图像等非结构化数据，特征重要性不是很相关，因为模型使用的特征或模式更复杂，并且不总是人类可以解释的。

*图 2.6* 说明了突出显示数据集的有影响的特征如何使最终用户关注重要特征的值，以证明模型结果的合理性:

![Figure 2.6 – A feature importance graph on the diabetes dataset (from the code tutorials)
](img/B18216_02_06.jpg)

图 2.6-糖尿病数据集的特征重要性图(来自代码教程)

接下来，我们将介绍另一种重要的基于影响的模型可解释性方法，称为敏感性分析。

## 敏感性分析

敏感性分析是一个量化过程，通过改变对预测模型使用的重要输入特征的假设来估算预测中的不确定性。在敏感性分析中，增加或减少单个输入特征变量，以评估单个特征对目标结果的影响。这种技术非常常用于预测建模，以优化系统的整体性能和鲁棒性。

对于任何数据科学项目来说，进行敏感性分析可能是一种简单但非常强大的方法，它可以为业务利益相关者提供额外的信息，尤其是对于多元数据集。它有助于理解*假设*场景，并观察任何特定特征是否对异常值或任何形式的敌对扰动敏感。它有助于质疑可变假设的可靠性，可以预测假设改变时可能的结果，并可以衡量改变可变假设的重要性。敏感性分析是一种数据驱动的建模方法。它表明数据对于建模过程是否可靠、准确和相关。此外，它有助于发现是否有其他干预因素会影响模型。

在 XAI 的背景下，由于敏感性分析与一些广泛使用的方法相比不太常见，所以让我尝试给出我对在 ML 中执行敏感性分析的建议。通常，这对于回归问题非常有用，但是对于基于分类的问题也非常重要。

请参考 github 存储库中提供的笔记本([https://GitHub . com/packt publishing/Applied-Machine-Learning-explability-Techniques/blob/main/chapter 02/feature importance _ sensitivity yanalysis . ipynb](https://github.com/PacktPublishing/Applied-Machine-Learning-Explainability-Techniques/blob/main/Chapter02/FeatureImportance_SensitivityAnalysis.ipynb))以获得进行灵敏度分析的详细实用方法。我建议您进行敏感性分析的第一步是计算原始数据集中每个属性的标准差(σ)。然后，对于每个属性，将原始属性值转换为-3σ、-2σ、-σ、σ、2σ和 3σ，并观察和绘制回归问题的目标结果的百分比变化，或者观察基于分类的问题的预测类。

对于一个好的和健壮的模型，我们希望目标结果对特征值的任何变化不太敏感。理想情况下，对于回归问题，我们希望目标结果的百分比变化不要太剧烈，而对于分类问题，预测的类别不应该随着特征值的改变而改变太多。任何超过+/- 3σ的特征值都被认为是异常值，所以通常情况下，我们会将特征值变化到+/- 3σ。

*图 2.7* 显示了详细的敏感性分析如何帮助您分析容易影响模型结果的因素:

![Figure 2.7 – Sensitivity analysis to understand the influential features of the data
](img/B18216_02_07.jpg)

图 2.7-敏感性分析，以了解数据的影响特征

除了敏感性分析，在下一节的中，您将了解到**部分相关图**(**PDP**，它也可用于分析有影响的特征。

## PDP

当使用黑盒 ML 模型时，检查特征属性和目标结果之间的功能关系可能是具有挑战性的。尽管计算特征重要性可能更容易，但 PDP 提供了一种机制来从功能上计算预测特征和预测变量之间的关系。它显示了一个或两个属性对目标结果的边际影响。

PDP 可以有效地帮助提取预测变量和预测变量之间的线性、单调或任何复杂的相互作用，并平均指示预测变量对预测变量的总体影响。PDP 通过测量边际效应包括特定预测属性的贡献，这不包括其他变量对特征空间的影响。

与敏感度分析类似，PDP帮助我们估计具体特性可能影响目标结果的方向。为了简单起见，我不会添加任何复杂的偏相关的数学表示来获得预测变量的平均边际效应；然而，我强烈建议浏览一下*杰罗姆·h·弗里德曼*关于*贪婪函数逼近:梯度推进机器*的作品，以获得更多信息。PDP 最重要的好处之一是它易于使用、实现和理解，并且可以非常容易地向非技术业务利益相关者或 ML 模型的最终用户解释。

但是这种方法也有某些缺点。默认情况下，该方法假设所有特征都不相关，并且特征属性之间没有交互。在任何实际场景中，这种情况都不太可能发生，因为大多数时候，由于特征变量，会有一些交互或联合效应。

PDP 也仅限于二维表示，PDP 不显示任何特征分布。因此，如果特征空间不是均匀分布的，在分析结果时，偏差的某些影响可能会被忽略。PDP 可能不会显示任何异质效应，因为它仅显示平均边际效应。这意味着，如果某个特定特性的一半数据对预测结果有正面影响，而另一半数据对预测结果有负面影响，那么 PDP 可能只是一条水平线，因为这两半的影响可以相互抵消。这可能导致特征对目标变量没有任何影响的结论，这是误导性的。

PDP 的弊端可以通过**累积局部效应图** ( **ALEP** )和**个体条件期望曲线** ( **ICE 曲线**)来解决。我们不会在本章中涉及这些概念，但请参考*参考*部分、*【参考–4，5】*，以获得帮助您理解这些概念的其他资源。

让我们来看看*图 2.8* 中的一些 PDP 可视化示例:

![Figure 2.8 – PDP visualizations (from the code tutorial)
](img/B18216_02_08.jpg)

图 2.8–PDP 可视化(来自代码教程)

*图 2.8* 展示了 PDP 可视化，帮助我们从表格数据集中了解有影响的特征。在下一节中，我们将讨论**分层相关性传播** ( **LRP** )方法，以理解来自非结构化数据的有影响的特征。

## LRP

我们之前讨论的大多数基于影响的方法对于结构化数据都非常有效。但遗憾的是，这些方法无法应用于特征并不总是定义清晰的图像、文本等非结构化数据，尤其是使用**深度卷积神经网络** ( **DCNNs** )时的。当应用于图像和文本等非结构化数据时，经典的 ML 算法与深度学习算法相比效率不高。由于与经典 ML 中的手动特征工程相比，深度学习中的自动特征提取的好处，深度学习算法在模型准确性方面更有效，因此更受欢迎。然而，深度学习模型比经典的 ML 模型更复杂，更难解释。

为深度学习模型提供可解释性也是相当具有挑战性的；通常，很少有量化的方法来为深度学习模型提供可解释性。因此，我们主要依靠定性方法来可视化能够影响权重和偏差计算过程的关键影响数据元素，这是任何深度学习模型的主要参数。此外，对于具有多层的深度网络，当通过层间梯度流动过程的信息流保持一致时，学习就发生了。因此，为了解释任何深度学习模型，特别是图像和文本，我们将尝试可视化网络不同层中的*激活的*或最有影响力的数据元素，并定性地检查算法的功能。

为了解释深度学习模型，LRP 是最突出的方法之一。直观地说，这种方法利用网络中的权重和前向传递神经激活，通过网络中的各个层将输出传播回输入层。因此，在网络权重的帮助下，我们可以将对最终模型输出贡献最大的数据元素(图像中的像素和文本数据中的单词)可视化。这些数据元素的贡献是通过网络层传播的相关性的定性度量。

现在，我们将探索一些特定的 LRP 方法，这些方法已经被应用于解释深度学习模型的工作。在实践中，实现这些方法可能具有挑战性。所以，我没有在代码教程中包括这些方法，因为这一章应该帮助初学者。我在*参考*部分分享了一些资源，供中级或高级学习器进行代码演练。

### 显著图

显著图是解释**卷积神经网络**(**CNN**)预测最常用的方法之一。这种技术源自图像显著性的概念，图像显著性指的是图像的重要特征，例如视觉上吸引人的像素。因此，显著性图是从原始图像导出的另一个图像，其中像素亮度与图像的显著性成正比。显著图有助于突出显示图像中在模型的最终决策过程中起重要作用的区域。这是一种专门在 DCNN 模型中使用的可视化技术，用于从数据中区分视觉特征。

除了为深度学习模型提供可解释性之外，显著图还可以用于识别感兴趣的区域，这些区域可以进一步被自动图像注释算法使用。此外，显著图用于音频领域，特别是音频监控，以检测异常的声音模式，如枪声或爆炸声。

*图 2.9* 显示了给定输入图像的显著图，它突出显示了模型用来预测结果的重要像素:

![Figure 2.9 – Saliency maps for an input image
](img/B18216_02_09.jpg)

图 2.9–输入图像的显著性图

接下来，让我们介绍另一种流行的 LRP 方法——**导向反向传播** ( **导向反向传播**)。

### 制导反投影

另一种可视化技术用于解释深度学习模型以增加信任度和它们的采用是**引导的反向投影**。引导式反向投影突出显示图像中的细微视觉细节，以解释模型预测特定类别的原因。它也被称为导向凸极，实际上结合了普通反向传播和通过 ReLU 非线性的反向传播过程(也称为**解耦**)。我强烈建议您看一下这篇文章，[https://towards data science . com/review-de convnet-un pooling-layer-semantic-segmentation-55 cf 8 a6 e 380 e](https://towardsdatascience.com/review-deconvnet-unpooling-layer-semantic-segmentation-55cf8a6e380e)，如果您不知道这些术语，请了解有关反向传播和 DeconvNet 机制的更多信息。

在该方法中，网络的神经元充当特征检测器，并且由于使用了 ReLU 激活函数，仅保留特征图中为正的梯度元素。此外，DeconvNets 仅保留正误差信号。由于负梯度被设置为零，当反向传播通过 ReLU 层时，只有重要的像素被突出显示。因此，这种方法有助于可视化图像的关键区域、重要形状以及将由算法分类的对象的轮廓。

*图 2.10* 显示了给定输入图像的引导后投影图，该图标记了模型用来预测结果的轮廓和一些粒度视觉特征:

![Figure 2.10 – Guided backprop for an input image
](img/B18216_02_10.jpg)

图 2.10-输入图像的引导后投影

引导反向投影非常有用，但在下一节中，我们将介绍另一种解释图像等非结构化数据的有用方法，称为梯度凸轮。

### 梯度凸轮

cam 是独立的可视化方法，用于解释深度学习模型。这里，模型预测的类分数被追溯到最后的卷积层，以突出图像中的有区别的感兴趣区域，这些区域是类特定的，甚至对于其他计算机视觉或图像处理算法来说不是通用的。**梯度 CAM** 结合了导向后投影和 CAM 的效果，突出了感兴趣的类别区分区域，而没有突出颗粒像素的重要性，这与导向后投影不同。但是 Grad-CAM 可以应用于任何 CNN 架构，不像 CAM 可以应用于在预测层之前对来自卷积层的输出特征图执行全局平均汇集的架构。

**Grad-CAM** (也称为**梯度加权类激活图**)有助于可视化高分辨率细节，这些细节通常叠加在原始图像上，以突出显示主要的图像区域，用于预测特定的类。对于多类分类模型极其有用。Grad-CAM 通过检查进入模型最后一层的梯度信息流来工作。然而，在某些情况下，检查细粒度的像素激活信息也很重要。由于 Grad-CAM 不允许我们检查粒度信息，Grad-CAM 还有另一个变体，称为的 **Guided Grad-CAM** ，用于结合 guided backprop 和 Grad-CAM 的优势，甚至可以可视化图像中粒度级的类别鉴别信息。

*图 2.11* 显示了 Grad-CAM 对任何输入图像的可视化效果:

![Figure 2.11 – Grad-CAM for an input image
](img/B18216_02_11.jpg)

图 2.11–输入图像的 Grad-CAM

Grad-CAM 突出显示图像中的重要区域，模型使用这些区域来预测结果。这种方法的另一种变体是使用导向 Grad-CAM，它结合了导向反向传播和 Grad-CAM 方法，以产生有趣的可视化来解释深度学习模型:

![Figure 2.12 – Architecture diagram for guided Grad-CAM
](img/B18216_02_12.jpg)

图 2.12–引导式 Grad-CAM 的架构图

*图 2.12* 显示了制导 Grad-CAM 方法的架构图，理解起来稍微复杂一些。但总的来说，LRP 是一种重要的方法，可以用来解释深度学习模型的功能。

## 基于表象的解释

模式表示在决策过程中起着重要的作用，尤其是对于文本和图像等非结构化数据。传统上，手工设计的模式匹配算法被用于提取人类能够涉及的全局特征。但最近，GoogleAI 基于 CAVs 的模型可解释性技术在 XAI 领域获得了极大的欢迎。在这一部分，我们将更详细地讨论 CAV，尽管从非结构化数据中提取特征和模式也属于基于表示的解释。

### 骑士队

特别是对于非结构化数据，大多数深度学习模型处理边缘、轮廓和主题等低级特征，以及一些中级和高级特征，如感兴趣对象的某些定义部分和部分。大多数时候，这些表示法并不人性化，尤其是对于复杂的深度学习模型。直觉上，CAV 将低级和粒度特征的存在与高级的对人友好的概念联系起来。因此，CAV 的模型可解释性提供了更现实的解释，任何人都可以与之相关联。

CAVs 的方法实际上是使用来自 GoogleAI 的概念激活向量 ( **TCAV** )框架**测试实现的。TCAV 利用方向导数将神经网络的内部状态近似为人类定义的概念。例如，如果我们要求一个人解释斑马看起来像什么，他们可能会说斑马是一种看起来像带有黑色条纹的白马的动物，生活在草原上。所以，*动物*、*白马*、*黑条纹*和*草原*这些术语都是用来表示斑马的重要概念。**

同样，TCAV 算法会尝试学习这些概念，并使用训练好的模型了解这些概念对预测有多重要，尽管在训练过程中可能不会用到这些概念。因此，TCAV 试图量化这个模型对特定阶级的特定概念的敏感程度。我发现骑士队的想法非常有吸引力。我认为这是朝着创建人工智能模型的人性化解释迈出的一步，任何非技术用户都可以轻松理解。我们将在第八章*和 TCAV* 的 [*中更详细地讨论 GoogleAI 的 TCAV 框架。*](B18216_08_ePub.xhtml#_idTextAnchor154)

*图 2.13* 展示了使用人类友好的概念来解释模型预测的想法。在下一小节中，我们将看到另一种用于解释复杂深度学习模型的可视化方法:

![Figure 2.13 – The fundamental idea behind the CAV 
](img/B18216_02_13.jpg)

图 2.13–CAV 背后的基本思想

接下来，我们将讨论**视觉注意力图** ( **VAMs** )，它也可以用于复杂的深度学习模型。

## VAMs

在最近几年里，transformer 模型架构因为能够在复杂的非结构化数据上实现最先进的模型性能而广受欢迎。注意力网络是 transformer 架构的核心，它允许算法学习更多的上下文信息，以产生更准确的结果。

基本的想法是，数据的每一部分都不是同等重要的，只有重要的特征比其余的数据需要更多的关注。因此，注意力网络会过滤掉数据中不相关的部分，以便做出更好的判断。通过注意机制，网络可以根据对基础任务的重要程度，将较高的权重分配给重要的部分。使用这些注意力权重，可以创建解释复杂算法的决策过程的某些可视化。这些被称为 VAM。

这种技术对于**多模式编码器-解码器**架构来说特别有用,用于解决诸如自动图像字幕和视觉问答等问题。如果你的理解是初级的，那么应用 VAM 可能会相当复杂。因此，我不会在本书或代码教程中详细介绍这种技术。如果你有兴趣了解更多关于这种技术在实践中如何工作的信息，请参考位于[https://github . com/sgrvinod/a-py torch-Tutorial-to-Image-Captioning](https://github.com/sgrvinod/a-PyTorch-Tutorial-to-Image-Captioning)的代码库。

正如我们在*图 2.14* 中看到的，VAM 提供了一步一步的视觉效果来解释复杂编码器-解码器模型的输出。在下一节中，我们将探索基于示例的方法，这些方法用于解释 ML 模型:

![Figure 2.14 – Using VAMs to explain complex encoder-decoder attention-based deep learning models for the task of automated image captioning using a multi-modal dataset
](img/B18216_02_14.jpg)

图 2.14–使用 VAM 解释复杂的编码器-解码器基于注意力的深度学习模型，用于使用多模态数据集的自动图像字幕任务

在下一节的中，我们将介绍另一种类型的可解释方法，它使用人类友好的例子来解释来自黑盒模型的预测。

# 基于实例的方法

另一种模型可解释性的方法是基于实例的方法。基于实例的方法类似于人类试图解释一个新概念。作为人类，当我们试图向他人解释或介绍新的东西时，我们通常会尝试使用我们的观众能够理解的例子。类似地，在 XAI 的背景下，基于实例的方法试图选择数据集的某些实例来解释模型的行为。它假设观察数据的当前实例与历史观察之间的相似性可以用来解释黑盒模型。

这些方法大多与模型无关，可以应用于结构化和非结构化数据。如果结构化数据是高维的，那么对于这些方法来说就有点困难了，并且不能包含所有的特征来解释模型。因此，只有当有一个选项来总结数据实例或只选取选定的特性时，它才能很好地工作。

在这一章中，我们将主要讨论**反事实解释** ( **CFEs** )，这是最流行的基于实例的可解释性方法，适用于结构化和非结构化数据。cfe 表明某一特定特征必须改变到什么程度才能显著改变预测的结果。通常，这对于基于分类的问题很有用。

对于某些预测模型，cfe可以提供对最终用户和业务利益相关者至关重要的说明性见解和建议。例如，让我们假设在自动化贷款审批系统中使用了一个 ML 模型。如果黑盒模型拒绝了特定申请人的贷款请求，贷款申请人可能会联系提供商，以了解他们的请求未被批准的确切原因。但相反，如果系统建议申请人增加 5000 英镑的工资，并在接下来的 3 个月内按时支付信用卡账单，以批准贷款请求，那么申请人将理解并信任系统的决策过程，并可以努力使其贷款请求获得批准。

## 结构化数据中的 cfe

使用 Python 中的**多样反事实解释** ( **骰子**)框架([https://interpret.ml/DiCE/](https://interpret.ml/DiCE/))，可以为结构化数据提供 CFE。它可以应用于分类和基于回归的模型不可知局部可解释性问题，它描述了结构化数据的最小变化如何改变目标结果。

Python 中用于 CFE 的另一个重要框架是**Alibi**([https://docs.seldon.io/projects/alibi/en/stable/](https://docs.seldon.io/projects/alibi/en/stable/))，它在实现 CFE 的概念来解释 ML 模型方面也相当不错。虽然我们将在第 9 章、*其他流行的 XAI 框架*中讨论这些框架并体验这些框架的实际方面，但现在，我将讨论对结构化数据的 CFE 的一些直观理解。请参考代码库中提供的笔记本([https://github . com/packt publishing/Applied-Machine-Learning-explability-Techniques/blob/main/chapter 02/counter factual _ structured _ data . ipynb](https://github.com/PacktPublishing/Applied-Machine-Learning-Explainability-Techniques/blob/main/Chapter02/Counterfactual_structured_data.ipynb))，了解如何用 Python 编写这些方法，以解决实际问题。

当与结构化数据一起使用时，CFE 方法尝试分析输入查询数据实例，并尝试观察考虑来自历史数据的相同查询实例的原始目标结果。或者，它尝试检查特征并将它们映射到历史数据中存在的类似实例，以获得目标输出。然后，该算法生成多个反事实的例子来预测相反的结果。

对于基于分类的问题，该方法将尝试预测二元分类问题的相反类，或者多类分类问题的最近或最相似类。对于回归问题，如果目标结果出现在光谱的低端，算法会尝试提供一个目标结果更接近光谱高端的反事实示例，反之亦然。因此，这种方法对于理解*假设*场景非常有效，并且可以提供可操作的洞察力以及模型解释能力。解释也非常清楚，非常容易解释和实现。

但是这种方法的主要缺点，尤其是对于结构化数据来说，是它遭受了*罗生门效应*([https://www . dictionary . com/e/pop-culture/the-Rashomon-effect/](https://www.dictionary.com/e/pop-culture/the-rashomon-effect/))。对于任何现实世界的问题，它可以找到多个可以相互矛盾的 cfe。有了结构化数据，有了多种特性，相互矛盾的 cfe 会制造更多的混乱，而不是解释 ML 模型！人工干预和应用领域知识来挑选最相关的例子有助于减轻罗生门效应。否则，我的建议是将这种方法与可操作特征的特征重要性方法结合起来，选择涉及重大变化的反事实例子，以提供更好的可操作性。

*图 2.15* 说明了如何使用 cfe 来获得说明性的见解和可行的建议，以解释模型的工作原理:

![Figure 2.15 – Prescriptive insights obtained from CFEs in structured data
](img/B18216_02_15.jpg)

图 2.15–从结构化数据中的 cfe 获得的说明性见解

表格数据集中的 cfe 非常有用，因为它们可以向最终用户提供可操作的建议。在下一小节中，我们将探讨非结构化数据中的 cfe。

## 非结构化数据中的 cfe

在图像和文本等非结构化数据中，实现 cfe 可能相当具有挑战性。其中一个主要原因是深度学习模型在图像或文本中使用的粒度特征并不总是定义良好或对人类友好的。但是**Alibi**([https://docs.seldon.io/projects/alibi/en/stable/](https://docs.seldon.io/projects/alibi/en/stable/))框架在生成图像数据的 cfe 方面做得很好。即使是简单 CFE 方法的改进版本，通过生成由类原型指导的 CFE，性能甚至更好。它使用自编码器或 k-d 树来为使用特定输入实例的每个预测类构建原型。

例如，在 MNIST 数据集中，让我们假设输入查询图像是数字 7。然后，反事实原型方法将构建从 0 到 9 的所有数字的原型。接下来，它将尝试产生除了原始数字 7 之外的最接近的数字作为反事实的例子。根据数据的不同，最接近的手写数字可以是 9 或 1；即使作为人类，如果字迹不清楚，我们也可能会混淆数字 7 和 9 或 7 和 1！它采用优化方法来最小化模型的反事实预测损失。

我强烈建议看一看*阿诺·范·卢韦伦*和*詹妮斯·克莱斯*的作品，由原型([https://arxiv.org/abs/1907.02584](https://arxiv.org/abs/1907.02584))引导的*可解释的反事实解释，以获得关于这种方法如何工作的更多细节。这种由原型指导的 CFE 方法还消除了由于黑盒深度学习模型的数值梯度评估过程而可能产生的任何计算约束。请看看 github 资源库中的笔记本([https://GitHub . com/packt publishing/Applied-Machine-Learning-explability-Techniques/blob/main/chapter 02/counter fact _ unstructured _ data . ipynb](https://github.com/PacktPublishing/Applied-Machine-Learning-Explainability-Techniques/blob/main/Chapter02/Counterfactual_unstructured_data.ipynb))了解一下如何针对实际问题实现这种方法。*

下图摘自 Goyal 等人的论文*反事实视觉解释，2019*(【https://arxiv.org/pdf/1904.07451.pdf】)显示了视觉 cfe 如何成为解释图像分类器的有效方法:

![Figure 2.16 – A counterfactual example-based explanation for images
](img/B18216_02_16.jpg)

图 2.16-一个基于反事实例子的图像解释

实际上，包含非结构化数据的 CFE 很难实现。这仍然是一个积极研究的领域，但我认为这种方法具有巨大的潜力，可以为甚至复杂的模型提供人性化的解释。下图显示了基于可解释类型的各种方法的映射:

![Figure 2.17 – Mapping various methods based on their explainability type
](img/B18216_02_17.jpg)

图 2.17——根据方法的可解释类型映射不同的方法

LIME 和 SHAP 是重要的局部和模型不可知算法，本章没有讨论，但是后面会详细讨论。本章讨论的模型可解释性方法广泛用于各种数据集，以提供不同维度的可解释性。

# 总结

在这一章中，你学习了用于解释黑盒模型的各种模型可解释性方法。其中一些是与模型无关的，而一些是特定于模型的。这些方法中的一些提供全局可解释性，而一些提供局部可解释性。对于这些方法中的大多数，通过绘图、图表和转换图的可视化被用于定性地检查数据或模型结果；而对于一些方法，使用某些例子来提供解释。统计和数字指标也可以在提供定量解释方面发挥重要作用。

在下一章，我们将讨论以数据为中心的 XAI 这个非常重要的概念，并从概念上理解如何在模型可解释性中利用以数据为中心的方法。

# 参考文献

要获得有关本章主题的更多信息，请参考以下资源:

*   杰罗姆·弗里德曼:“贪婪函数逼近:梯度推进机器”统计年鉴(2001):[https://www . research gate . net/publication/280687718 _ Greedy _ Function _ Approximation _ A _ Gradient _ Boosting _ Machine](https://www.researchgate.net/publication/280687718_Greedy_Function_Approximation_A_Gradient_Boosting_Machine)
*   *用 1.5xIQR 规则识别异常值*:[https://www . khanacademy . org/math/statistics-probability/summaring-quantitative-data/box-whisker-plots/a/Identifying-outliers-iqr-rule](https://www.khanacademy.org/math/statistics-probability/summarizing-quantitative-data/box-whisker-plots/a/identifying-outliers-iqr-rule)
*   *尼尔森规则*:[https://www . leanssix sigma definition . com/glossary/Nelson-rules/](https://www.leansixsigmadefinition.com/glossary/nelson-rules/)
*   *累积局部效果(ALE)–特征效果全局可解释性*:*[https://www . analyticsvidhya . com/blog/2020/10/Accumulated-Local-Effects-ALE-Feature-Effects-Global-interprebility/](https://www.analyticsvidhya.com/blog/2020/10/accumulated-local-effects-ale-feature-effects-global-interpretability/)*
**   *使用个体条件期望(ICE)图的模型不可知的局部解释*:[https://towards data science . com/how-to-explain-and-affect-Individual-decision-with-ICE-curves-1-2-f39fd 751546 f](https://towardsdatascience.com/how-to-explain-and-affect-individual-decisions-with-ice-curves-1-2-f39fd751546f)*   *图 2.16:反事实视觉解释，戈亚尔等人 2019*:【https://arxiv.org/pdf/1904.07451.pdf *   *图 2.13:特征归因之外的可解释性:用概念激活向量进行定量测试(TCAV)，金等【2018】*:【https://arxiv.org/abs/1711.11279】T2*   *Grad-CAM 类激活可视化*:【https://keras.io/examples/vision/grad_cam/ *   使用引导梯度类激活图解释 CNN 的通用方法！！:[https://medium . com/@ chinesh 4/generalized-way-of-interpretation-CNNs-a7d1b 0178709](mailto:https://medium.com/@chinesh4/generalized-way-of-interpreting-cnns-a7d1b0178709)*   *图 2.12: Grad-CAM:通过基于梯度的定位从深度网络得到的视觉解释，Ramprasaath 等人。阿尔-*【https://arxiv.org/abs/1610.02391】T2*